{% extends "admin/base_site.html" %}
{% load i18n static %}
{% block title %}{{ title }} | {{ site_title|default:_("Django site admin") }}{% endblock %}
{% block extrastyle %}
    {{ block.super }}
    <style>
.enroll-container {
    max-width: 600px;
    margin: 20px 0;
}
.step-instruction {
    border-left: 4px solid #2196f3;
    padding: 15px 20px;
    margin: 20px 0;
}
.status-message {
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
    display: none;
}
.status-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}
.status-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
    </style>
{% endblock %}
{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
        &rsaquo; <a href="{{ management_url }}">Manage Passkeys</a>
        &rsaquo; {{ title }}
    </div>
{% endblock %}
{% block content %}
    <div class="module">
        <div class="enroll-container">
            <div class="step-instruction">
                <strong>Step 1:</strong> Click "Register Passkey" below and follow your browser's prompts.
                <br>
                <strong>Step 2:</strong> Give your passkey a memorable name.
                <br>
                <strong>Step 3:</strong> Use your device's authentication method (Touch ID, Face ID, etc.).
            </div>
            <div id="status-messages">
                <div id="success-message" class="status-message status-success">
                    Passkey registered successfully! You can now use it to sign in.
                </div>
                <div id="error-message" class="status-message status-error">
                    <span id="error-text"></span>
                </div>
            </div>
            <form id="passkey-form">
                {% csrf_token %}
                <input type="hidden" name="username" value="{{ user.username }}">
                <div class="form-row">
                    <label for="passkey-name">Passkey Name:</label>
                    <input type="text"
                           id="passkey-name"
                           name="name"
                           placeholder="e.g., My MacBook Pro"
                           style="width: 300px;
                                  padding: 8px;
                                  margin: 10px 0">
                    <p class="help">Choose a name that helps you identify this device or authenticator.</p>
                </div>
                <div class="submit-row">
                    <input type="button"
                           id="register-btn"
                           value="ðŸ”‘ Register Passkey"
                           class="default">
                </div>
            </form>
        </div>
    </div>
    <!-- Include passkeys JavaScript libraries -->
    <script type="application/javascript"
            src="{% static 'passkeys/js/base64url.js' %}"></script>
    <script type="application/javascript"
            src="{% static 'passkeys/js/helpers.js' %}"></script>
    <script>
// Registration-specific function to process credential creation options
// Based on the working example from django-passkeys
var MakeCredReq = (makeCredReq) => {
    makeCredReq.publicKey.challenge = base64url.decode(makeCredReq.publicKey.challenge);
    makeCredReq.publicKey.user.id = base64url.decode(makeCredReq.publicKey.user.id);

    if (makeCredReq.publicKey.excludeCredentials) {
        for(let excludeCred of makeCredReq.publicKey.excludeCredentials) {
            excludeCred.id = base64url.decode(excludeCred.id);
        }
    }

    return makeCredReq;
}

// Registration function based on django-passkeys working example
function begin_reg() {
    const name = document.getElementById('passkey-name').value.trim();
    if (!name) {
        showError('Please enter a name for your passkey.');
        return;
    }
    
    const registerBtn = document.getElementById('register-btn');
    registerBtn.disabled = true;
    registerBtn.value = 'Registering...';
    
    fetch('{% url 'passkeys:reg_begin' %}', {})
        .then(function(response) {
            if(response.ok) {
                return response.json().then(function (req){
                    return MakeCredReq(req)
                });
            }
            throw new Error('Error getting registration data!');
        })
        .then(function(options) {
            console.log(options)
            return navigator.credentials.create(options);
        })
        .then(function(attestation) {
            attestation["key_name"] = name;
            return fetch('{% url 'passkeys:reg_complete' %}', {
                method: 'POST',
                body: JSON.stringify(publicKeyCredentialToJSON(attestation))
            });
        })
        .then(function(response) {
            return response.json()
        })
        .then(function (res) {
            if (res["status"] == 'OK') {
                showSuccess();
            } else {
                showError('Registration Failed: ' + res["message"]);
                registerBtn.disabled = false;
                registerBtn.value = 'ðŸ”‘ Register Passkey';
            }
        }, function(reason) {
            showError('Registration Failed: ' + reason);
            registerBtn.disabled = false;
            registerBtn.value = 'ðŸ”‘ Register Passkey';
        });
}

document.addEventListener('DOMContentLoaded', function() {
    const registerBtn = document.getElementById('register-btn');
    const passkeyNameInput = document.getElementById('passkey-name');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    
    // Auto-generate a default name based on browser/platform
    if (!passkeyNameInput.value) {
        const userAgent = navigator.userAgent;
        let defaultName = 'My Device';
        
        if (userAgent.includes('Mac')) {
            defaultName = 'My Mac';
        } else if (userAgent.includes('Windows')) {
            defaultName = 'My Windows PC';
        } else if (userAgent.includes('iPhone')) {
            defaultName = 'My iPhone';
        } else if (userAgent.includes('Android')) {
            defaultName = 'My Android Device';
        }
        
        passkeyNameInput.value = defaultName;
    }
    
    // Check WebAuthn support
    if (!window.PublicKeyCredential) {
        showError('Passkeys are not supported on this device/browser.');
        registerBtn.disabled = true;
        return;
    }
    
    // Check if running over HTTPS (required for WebAuthn)
    if (location.protocol != 'https:' && location.hostname != 'localhost' && location.hostname != '127.0.0.1') {
        showError('Passkeys require a secure connection (HTTPS).');
        registerBtn.disabled = true;
        return;
    }
    
    function showError(message) {
        errorText.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
    }
    
    function showSuccess() {
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        setTimeout(() => {
            window.location.href = '{{ management_url }}';
        }, 2000);
    }
    
    // Make functions available globally so they can be used in the template
    window.showError = showError;
    window.showSuccess = showSuccess;
    
    registerBtn.addEventListener('click', begin_reg);
});
    </script>
{% endblock %}
